<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
      html, body, #map-canvas {
        height: 100%;
        margin: 0px;
        padding: 0px
      }
    #info-box {
      background-color: white;
      border: 1px solid black;
      bottom: 30px;
      padding: 10px;
      position: absolute;
      left: 30px;
      font-family: Arial, Tahoma;
      font-size: small;
    }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true"></script>
    <script>
var map;
var mapStyle = [{
  'featureType': 'all',
  'elementType': 'all',
  'stylers': [{'visibility': 'off'}]
}, {
  'featureType': 'landscape',
  'elementType': 'geometry',
  'stylers': [{'visibility': 'on'}, {'color': '#fcfcfc'}]
}, {
  'featureType': 'water',
  'elementType': 'labels',
  'stylers': [{'visibility': 'off'}]
}, {
  'featureType': 'water',
  'elementType': 'geometry',
  'stylers': [{'visibility': 'on'}, {'hue': '#5f94ff'}, {'lightness': 60}]
}];


google.maps.event.addDomListener(window, 'load', function() {
  //debugger;
  console.log('window.load')
  map = new google.maps.Map(document.getElementById('map-canvas'), {
    center: { lat: 37.745997, lng: -122.506326 },
    zoom: 8,
    styles: mapStyle
  });

  map.data.setStyle(styleFeature);

  // var ctaLayer = new google.maps.KmlLayer({
  //   url: '../data/Quaternary.kmz'
  // });
  // ctaLayer.setMap(map);
  // console.log('kmz layer added');

  map.data.addListener('mouseover', function(event) {
    $("#info-box").html(populateInfo(event.feature));
  });
  console.log('adding earthquake events')
  $.getJSON( "http://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_month.geojson", function( data ) {
    map.data.addGeoJson(data);
    console.log(map.getBounds().getNorthEast());
    console.log(map.getBounds().getSouthWest());
  });
  // console.log('adding fault line features')
  // $.getJSON( "../data/quaternary.geojson", function( data ) {
  //   map.data.addGeoJson(data);
  // });
});

function populateInfo(data){
  var info = "";
  if(data.getProperty("place"))
  {
    info +=  data.getProperty("place") + "<br/>";
    info += "magnitude: " + data.getProperty("mag") + "<br/>";
    info += new Date(data.getProperty("time"));
  }
  else
  {
    info +=  data.getProperty("Name");
  }

  return info;
}

function styleFeature(feature) {
  var low = [151, 83, 34];   // color of mag 1.0
  var high = [5, 69, 54];  // color of mag 6.0 and above
  var minMag = 1.0;
  var maxMag = 6.0;

  // fraction represents where the value sits between the min and max
  var fraction = (Math.min(feature.getProperty('mag'), maxMag) - minMag) /
      (maxMag - minMag);

  var color = interpolateHsl(low, high, fraction);

  return {
    icon: {
      path: google.maps.SymbolPath.CIRCLE,
      strokeWeight: 0.5,
      strokeColor: '#fff',
      fillColor: color,
      fillOpacity: 2 / feature.getProperty('mag'),
      // while an exponent would technically be correct, quadratic looks nicer
      scale: Math.pow(feature.getProperty('mag'), 2)
    },
    zIndex: Math.floor(feature.getProperty('mag'))
  };
}

function interpolateHsl(lowHsl, highHsl, fraction) {
  var color = [];
  for (var i = 0; i < 3; i++) {
    // Calculate color based on the fraction.
    color[i] = (highHsl[i] - lowHsl[i]) * fraction + lowHsl[i];
  }

  return 'hsl(' + color[0] + ',' + color[1] + '%,' + color[2] + '%)';
}

    </script>
  </head>
  <body id="map-container">
    <div id="map-canvas"></div>
    <div id="info-box">Hover over an event for more details</div>
  </body>
</html>